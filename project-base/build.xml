<?xml version="1.0" encoding="UTF-8"?>
<project name="Shopsys6" default="build">

	<property name="path.app" value="${path.root}/app"/>
	<property name="path.bin" value="${path.root}/bin"/>
	<property name="path.build" value="${path.root}/build"/>
	<property name="path.build.properties.local" value="${path.build}/build.local.properties"/>
	<property name="path.composer.executable" value="composer"/>
	<property name="path.grunt.executable" value="${path.root}/node_modules/.bin/grunt"/>
	<property name="path.npm.executable" value="npm"/>
	<property name="path.php.executable" value="php"/>
	<property name="path.phpcs.executable" value="${path.bin}/phpcs"/>
	<property name="path.phpcs.ruleset" value="${path.build}/rulesetCS.xml"/>
	<property name="path.phplint.executable" value="${path.bin}/parallel-lint"/>
	<property name="path.phpmd.executable" value="${path.bin}/phpmd"/>
	<property name="path.phpmd.ruleset" value="${path.build}/rulesetMD.xml"/>
	<property name="path.phpunit.configuration" value="${path.app}/phpunit.xml"/>
	<property name="path.phpunit.executable" value="${path.bin}/phpunit"/>
	<property name="path.root" value="."/>
	<property name="path.src" value="${path.root}/src"/>
	<property name="path.vendor" value="${path.root}/vendor"/>
	<property name="path.web" value="${path.root}/web"/>

	<if>
		<os family="windows" />
		<then>
			<property name="dev.null" value="NUL"/>
		</then>
		<else>
			<property name="dev.null" value="/dev/null"/>
		</else>
	</if>

	<property file="${path.build.properties.local}" override="true"/>

	<target name="build" depends="clean,composer,configs-check,npm,img-dirs,assetic,assets,grunt,db-rebuild,warmup"/>
	<target name="build-demo" depends="clean,composer,configs-check,npm,img-dirs,assetic,assets,grunt,db-demo,warmup"/>
	<target name="build-demo-dev" depends="clean,composer-dev,configs-check,npm,img-dirs,assetic,assets,grunt,db-demo,warmup,standards"/>
	<target name="build-dev" depends="clean,composer-dev,configs-check,npm,img-dirs,assetic,assets,grunt,db-rebuild,warmup,standards"/>
	<target name="db-demo" depends="db-drop,db-create,db-fixtures-demo,products-visibility"/>
	<target name="db-rebuild" depends="db-drop,db-create,db-fixtures-base-settings"/>
	<target name="standards" depends="phplint,phpcs,phpmd,twig-lint,test-db-demo,tests,tests-db,tests-crawler"/>
	<target name="test-db-demo" depends="test-db-drop,test-db-create,test-db-fixtures-demo,products-visibility"/>

	<target name="assetic">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true" output="${dev.null}">
			<arg value="app/console" />
			<arg value="assetic:dump" />
		</exec>
	</target>

	<target name="assets">
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${path.root}/web/bundles/">
				<exclude name="/" />
			</fileset>
		</delete>
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="assets:install" />
			<arg value="${path.root}/web/" />
		</exec>
	</target>

	<target name="clean">
		<mkdir dir="${path.app}/cache" mode="0770"/>
		<mkdir dir="${path.app}/logs" mode="0770"/>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${path.app}/cache/">
				<exclude name="/" />
			</fileset>
			<fileset dir="${path.app}/logs/">
				<exclude name="/" />
			</fileset>
		</delete>
	</target>

	<target name="composer">
		<exec
			executable="${path.composer.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="install" />
			<arg value="--no-dev" />
		</exec>
	</target>

	<target name="composer-dev">
		<exec
			executable="${path.composer.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="install"/>
		</exec>
	</target>

	<target name="configs-check">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="${path.app}/checkConfigVersions.php" />
		</exec>
	</target>

	<target name="db-create">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="doctrine:schema:create" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="db-drop">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="doctrine:schema:drop" />
			<arg value="--force" />
			<arg value="--full-database" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="db-fixtures-base-settings">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="doctrine:fixtures:load" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Base" />
			<arg value="--append" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="db-fixtures-demo">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="doctrine:fixtures:load" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Base" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Demo" />
			<arg value="--append" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="docs">
		<exec executable="${path.grunt.executable}" passthru="true" checkreturn="true">
			<arg value="docs" />
		</exec>
	</target>

	<target name="dump-translations">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="translation:extract" />
			<arg value="--bundle=SS6ShopBundle" />
			<arg value="--dir=${path.src}/SS6/ShopBundle/Controller" />
			<arg value="--dir=${path.src}/SS6/ShopBundle/Form" />
			<arg value="--dir=${path.src}/SS6/ShopBundle/Model" />
			<arg value="--dir=${path.src}/SS6/ShopBundle/Resources/views" />
			<arg value="--dir=${path.src}/SS6/ShopBundle/Resources/scripts" />
			<arg value="--exclude-dir=admin/plugins" />
			<arg value="--exclude-dir=frontend/plugins" />
			<arg value="--keep" />
			<arg value="--output-format=po" />

			<arg value="cs" />
			<arg value="en" />
		</exec>
	</target>

	<target name="grunt">
		<exec executable="${path.grunt.executable}" passthru="true" checkreturn="true" />
	</target>

	<target name="img-dirs">
		<delete includeemptydirs="true">
			<fileset dir="${path.root}/web/assets/content/images">
				<exclude name="noimage.gif" />
				<exclude name =".gitignore" />
			</fileset>
		</delete>
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="ss6:image:directories" />
		</exec>
	</target>

	<target name="img-demo">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="ss6:image:demo" />
		</exec>
	</target>

	<target name="npm">
		<exec
			executable="${path.npm.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="install"/>
		</exec>
	</target>

	<target name="phpcs">
		<exec
			executable="${path.phpcs.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="--standard=${path.phpcs.ruleset}"/>
			<arg value="--extensions=php"/>
			<arg value="--encoding=utf-8"/>
			<arg value="-sp"/>
			<arg path="${path.src}"/>
		</exec>
	</target>

	<target name="phplint">
		<exec
			executable="${path.phplint.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg path="${path.src}"/>
		</exec>
	</target>

	<target name="phpmd">
		<exec
			executable="${path.phpmd.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="${path.src}"/>
			<arg value="text"/>
			<arg value="${path.phpmd.ruleset}"/>
			<arg value="--extensions=php"/>
		</exec>
	</target>

	<target name="products-visibility">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="ss6:product:visibility" />
		</exec>
	</target>

	<target name="tests">
		<exec
			executable="${path.phpunit.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="--configuration"/>
			<arg value="${path.phpunit.configuration}"/>
			<arg value="--testsuite"/>
			<arg value="Tests"/>
		</exec>
	</target>

	<target name="tests-db">
		<exec
			executable="${path.phpunit.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="--configuration"/>
			<arg value="${path.phpunit.configuration}"/>
			<arg value="--testsuite"/>
			<arg value="TestsDb"/>
		</exec>
	</target>

	<target name="tests-crawler">
		<exec
			executable="${path.phpunit.executable}"
			logoutput="true"
			passthru="true"
			checkreturn="true"
		>
			<arg value="--configuration"/>
			<arg value="${path.phpunit.configuration}"/>
			<arg value="--testsuite"/>
			<arg value="TestsCrawler"/>
		</exec>
	</target>

	<target name="test-db-create">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="--env=test" />
			<arg value="doctrine:schema:create" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="test-db-drop">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="--env=test" />
			<arg value="doctrine:schema:drop" />
			<arg value="--force" />
			<arg value="--full-database" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="test-db-fixtures-base-settings">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="--env=test" />
			<arg value="doctrine:fixtures:load" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Base" />
			<arg value="--append" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="test-db-fixtures-demo">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="--env=test" />
			<arg value="doctrine:fixtures:load" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Base" />
			<arg value="--fixtures=${path.src}/SS6/ShopBundle/DataFixtures/Demo" />
			<arg value="--append" />
			<arg value="--no-interaction" />
		</exec>
	</target>

	<target name="twig-lint">
		<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
			<arg value="app/console" />
			<arg value="twig:lint" />
			<arg value="@SS6ShopBundle" />
		</exec>
	</target>

	<target name="warmup">
		<if>
			<available file="${path.root}/PRODUCTION"/>
			<then>
				<exec executable="${path.php.executable}" passthru="true" checkreturn="true">
					<arg value="app/console" />
					<arg value="cache:warmup" />
				</exec>
			</then>
		</if>
	</target>

</project>
